{% extends 'base.html' %}

{% block title %}Inventory Dashboard{% endblock %}

{% block content %}
    <h2>Product Inventory ({{ products|length }} items)</h2>

    <div class="metrics-bar">
        <h2>Total Stock Value: ₹{{ "%.2f"|format(total_value) }}</h2>
    </div>
    
    <section class="sales-form-container">
        <h3>Process Quick Sale</h3>
        <form id="saleForm" method="POST" action="{{ url_for('process_sale') }}" class="sale-form">
            <select name="product_id" required>
                <option value="">-- Select Product --</option>
                {% for product in products %}
                    <option value="{{ product.id }}">{{ product.name }} ({{ product.stock }} in stock)</option>
                {% endfor %}
            </select>
            <input type="number" name="quantity" id="saleQuantity" placeholder="Quantity Sold" required min="1">
            <button type="submit">Complete Sale</button>
        </form>
    </section>

    <div class="inventory-grid">
        {% for product in products %}
            {% set is_low = product.stock <= product.low_stock_threshold %} 
            
            <div class="product-card {% if is_low %}low-stock{% endif %} {% if product.is_watched %}watched{% endif %}">
                
                <div class="image-container">
                    {% if product.image_url and (product.image_url.startswith('http://') or product.image_url.startswith('https://')) %}
                        <img src="{{ product.image_url }}" 
                             alt="{{ product.name }}" 
                             onerror="this.onerror=null; this.src='{{ url_for('static', filename='default.png') }}';">
                    {% else %}
                        <img src="{{ url_for('static', filename=product.image_url) }}" 
                             alt="{{ product.name }}" 
                             onerror="this.onerror=null; this.src='{{ url_for('static', filename='default.png') }}';">
                    {% endif %}
                </div>

                <div class="card-header">
                    <h3>{{ product.name }}</h3>
                    <div class="actions-wrapper">
                        <button class="watchlist-btn" data-product-id="{{ product.id }}">
                            {% if product.is_watched %}⭐ Watched{% else %}☆ Watchlist{% endif %}
                        </button>
                        <span class="stock-badge">Stock: {{ product.stock }}</span>
                    </div>
                </div>
                
                <p>Price: ₹{{ "%.2f"|format(product.price) }}</p>
                <p>Low Stock Threshold: {{ product.low_stock_threshold }}</p>
                
                {% if is_low %}
                    <p class="alert-text">⚠️ **LOW STOCK**</p>
                {% endif %}

                <div class="card-actions">
                    <button class="edit-btn" onclick="alert('Editing functionality would go here!')">Edit</button>
                    <form method="POST" action="{{ url_for('delete_product', product_id=product.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this product?');">
                        <button type="submit" class="delete-btn">Delete</button>
                    </form>
                </div>
            </div>
        {% else %}
            <p>No products found in inventory. Add one now!</p>
        {% endfor %}
    </div>
{% endblock %}